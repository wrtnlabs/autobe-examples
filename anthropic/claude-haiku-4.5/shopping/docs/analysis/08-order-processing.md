# Order Processing\n\n## Overview\n\nThe Order Processing system manages the complete lifecycle of customer orders from initial placement through fulfillment. This system coordinates between multiple platform components including inventory management, payment processing, shipping, and seller fulfillment to ensure reliable and traceable order processing.\n\nTHE Order Processing system SHALL serve as the central orchestration point for all transaction workflows, ensuring consistency between customer expectations, payment authorization, inventory allocation, and seller fulfillment responsibilities.\n\n## Order Placement Workflow\n\n### Complete Order Placement Process\n\nWHEN a customer initiates checkout from their shopping cart, THE system SHALL execute the following sequence of validation and processing steps:\n\n#### Phase 1: Cart Validation\n\nWHEN checkout begins, THE system SHALL validate that the customer's cart contains at least one item.\n\nWHEN validating cart items, THE system SHALL verify each item's current availability and price:\n- WHEN a cart item product status is \"ACTIVE\", THE item is available\n- WHEN a cart item product status is \"INACTIVE\" or \"ARCHIVED\", THE system SHALL reject the cart and display error\n- WHEN a cart item inventory quantity is insufficient, THE system SHALL reject and display available quantity\n- WHEN a cart item price has changed by more than 10%, THE system SHALL display price change warning and require customer confirmation\n\nIF any cart item validation fails, THEN THE system SHALL prevent checkout progression and notify customer with specific reasons.\n\n#### Phase 2: Delivery Address Selection and Validation\n\nWHEN customer proceeds past cart validation, THE system SHALL require selection of a delivery address.\n\nTHE customer SHALL select an address from saved addresses or add a new address.\n\nWHEN a new address is provided, THE system SHALL validate the address format and completeness:\n- THE address validation SHALL require street address, city, postal code, and country at minimum\n- THE system SHALL validate postal code format matches the selected country (5 digits for US, specific format for UK, etc.)\n- THE system SHALL validate that the address is recognized by available shipping carriers\n- THE system SHALL reject addresses flagged as restricted, military, or high-risk by shipping carriers\n\nIF address validation fails, THEN THE system SHALL display specific field error messages and prevent checkout progression.\n\n#### Phase 3: Shipping Method Selection\n\nWHEN customer proceeds to shipping method selection, THE system SHALL present available shipping methods based on:\n- Delivery address postal code and country\n- Total order weight and dimensions\n- Destination distance from seller/warehouse location\n- Seller's configured shipping methods\n- Carrier service availability in that specific region\n\nWHEN displaying shipping methods, THE system SHALL calculate and display:\n- Shipping cost for each method\n- Estimated delivery date range\n- Expected delivery window (if available from carrier)\n\nTHE customer SHALL select their preferred shipping method before proceeding.\n\nIF selected destination is not supported by any carrier, THEN THE system SHALL prevent checkout and suggest alternative addresses.\n\n#### Phase 4: Order Preview and Review\n\nWHEN customer reviews order before final confirmation, THE system SHALL display:\n- All items in the order with quantities and individual prices\n- Calculated subtotal (sum of all item prices Ã— quantities)\n- Applicable taxes calculated based on delivery address\n- Shipping costs calculated based on selected method\n- Order grand total (subtotal + taxes + shipping)\n- Selected delivery address\n- Selected shipping method\n- Selected payment method\n- Estimated delivery date range\n\nWHEN displaying order preview, THE system SHALL perform final validation:\n- WHEN any item is no longer available, THE system SHALL display warning and prevent confirmation\n- WHEN any price has changed, THE system SHALL display new price and require confirmation\n- WHEN taxes or shipping calculation changed, THE system SHALL display updated totals and require confirmation\n\nIF any change prevents order confirmation, THEN THE system SHALL allow customer to return to cart to modify items.\n\n#### Phase 5: Order Creation and Payment Authorization\n\nWHEN customer confirms final order placement, THE system SHALL:\n1. Create an order record in \"PENDING_PAYMENT\" status with timestamp\n2. Record the order ID (unique identifier)\n3. Link the order to the customer account\n4. Reserve inventory for each ordered item (place inventory hold)\n5. Record the order timestamp\n6. Proceed to payment processing\n\nWHEN creating the order record, THE system SHALL capture:\n- All cart items with quantities, prices at time of order, and seller associations\n- Calculated subtotal, taxes, shipping, and total amount\n- Delivery address (complete and validated)\n- Shipping method and cost\n- Customer ID and verification status\n- Order status progression timeline\n\n#### Phase 6: Payment Processing\n\nWHEN order is created with PENDING_PAYMENT status, THE system SHALL initiate payment processing.\n\nWHEN payment is submitted, THE system SHALL validate payment amount matches order total exactly (see [Payment Processing Document](./07-payment-processing.md) for complete payment workflows).\n\nWHEN payment gateway confirms successful authorization, THE system SHALL:\n- Record authorization confirmation timestamp\n- Update order status to \"CONFIRMED\"\n- Atomically reduce inventory (convert reserved inventory to allocated inventory)\n- Proceed to order confirmation phase\n\nWHEN payment fails or times out, THE system SHALL:\n- Update order status to \"CANCELLED\"\n- Release all inventory reservations\n- Notify customer of failure with specific reason\n- Allow customer to retry or contact support\n\n#### Phase 7: Order Confirmation and Notifications\n\nWHEN payment is successfully processed, THE system SHALL:\n1. Update order status to \"CONFIRMED\"\n2. Record confirmation timestamp\n3. Atomically deduct inventory for each SKU in order (inventory commitment)\n4. Create individual seller orders for each distinct seller's products (if multi-seller order)\n5. Generate order confirmation number\n6. Send order confirmation to customer email\n7. Send order notification to all relevant sellers\n8. Link shipping tracking information when available\n\nWHEN order confirmation occurs, THE system SHALL atomically complete ALL of the following or NONE (atomic transaction):\n- Inventory deduction for all SKUs\n- Seller order creation for all sellers\n- Status update for all line items\n- Commission calculation\n- Order confirmation record creation\n\nIF any operation fails during atomic transaction, THE system SHALL rollback all changes and notify admin for manual intervention.\n\n### Order Placement Requirements Summary\n\nWHEN a customer places an order, THE system SHALL enforce the following requirements:\n\n- THE order SHALL contain between 1 and 500 items\n- THE order total SHALL not exceed $1,000,000 (system anti-fraud limit)\n- THE order SHALL include a validated delivery address\n- THE order SHALL include a selected shipping method\n- THE customer placing the order SHALL be verified and authenticated\n- ALL status transitions SHALL complete within defined timeframes\n- THE order SHALL maintain referential integrity with inventory records\n\n## Order Creation and Validation\n\n### Pre-Order Validation Checks\n\nBEFORE creating an order, THE system SHALL perform comprehensive validation:\n\n#### 1. Inventory Validation\n\nWHEN processing an order, THE system SHALL verify each ordered item's inventory in real-time:\n\nWHEN validating inventory, THE system SHALL:\n- Check current stock quantity for each SKU\n- Compare requested quantity against available quantity (current stock minus reserved for other orders)\n- Validate that inventory is sufficient for ALL items in order (all-or-nothing validation)\n- Verify that inventory status is \"ACTIVE\" (not discontinued or archived)\n\nIF inventory is insufficient for any item, THEN THE system SHALL prevent order creation and display:\n- Which item is insufficient\n- Current available quantity for that item\n- Suggestion to modify quantity or remove item\n\nIF inventory status is inactive, THEN THE system SHALL prevent order creation with message explaining product is no longer available.\n\n#### 2. Customer Account Validation\n\nWHEN validating customer account, THE system SHALL verify:\n- Customer account is in \"ACTIVE\" status (not suspended or deactivated)\n- Customer email address is confirmed/verified\n- Customer account is not flagged for fraud or abuse\n- Customer has not exceeded daily order creation limit (if applicable)\n\nIF customer account validation fails, THEN THE system SHALL prevent order creation and display reason.\n\n#### 3. Product Information Validation\n\nWHEN validating products in order, THE system SHALL verify:\n- Each product status is \"ACTIVE\" (not archived or removed)\n- Each product's seller account is verified and active\n- Each product SKU variant exists and is available\n- Product information matches what customer selected (validates no product data corruption)\n\nIF product validation fails, THEN THE system SHALL prevent order creation and display error message.\n\n#### 4. Price Validation\n\nWHEN validating order pricing, THE system SHALL:\n- Compare cart prices with current product prices\n- Calculate order subtotal from individual item prices and quantities\n- Compare calculated subtotal with stored cart subtotal\n- Alert customer if any item price has changed significantly (>10% increase)\n\nIF price validation fails, THEN THE system SHALL display price change information and require customer reconfirmation before proceeding.\n\n#### 5. Address Validation\n\nWHEN validating delivery address, THE system SHALL verify:\n- Address is complete (all required fields provided)\n- Address format is properly validated\n- Address country is in supported shipping countries list\n- Address is not flagged as restricted or high-risk by shipping providers\n- Postal code format matches country standard\n\nIF address validation fails, THEN THE system SHALL display specific field that failed and prevent order creation.\n\n#### 6. Business Rule Validation\n\nWHEN creating order, THE system SHALL validate all applicable business rules:\n- Customer is not creating duplicate orders (same items within 5 minutes) - prevents accidental double-orders\n- Applied promotional codes are still valid and applicable\n- Order total is within acceptable range (minimum $0.01, maximum $1,000,000)\n- Seller account is not in \"SUSPENDED\" or \"DEACTIVATED\" status\n\nIF business rule validation fails, THEN THE system SHALL prevent order creation with clear explanation.\n\n### Order Record Creation\n\nWHEN all validations pass, THE system SHALL create an order record containing:\n\n**Order Metadata**\n```\nOrder ID: Unique system identifier (UUID)\nOrder Number: Human-readable format (ORD-YYYYMMDD-XXXXXX)\nOrder Status: Initially \"PENDING_PAYMENT\"\nCustomer ID: Reference to customer account\nOrder Creation Timestamp: ISO 8601 format, immutable\nOrder Version: For concurrency control\n```\n\n**Pricing Information**\n```\nSubtotal: Sum of (price Ã— quantity) for all items\nTax Amount: Calculated based on delivery address\nShipping Cost: Based on selected method\nDiscount Amount: If promotional codes applied\nTotal Amount: Subtotal + Tax + Shipping - Discounts\nCurrency: USD (or applicable currency)\n```\n\n**Delivery Information**\n```\nDelivery Address: Complete validated address\nDelivery Address Validation Status: VERIFIED\nEstimated Delivery Date Range: Based on shipping method\nDelivery Method: Carrier and service type\n```\n\n**Item Details (array of line items)**\n```\nFor each item:\n  - Product ID (reference to product)\n  - Product Name: As displayed to customer\n  - Product Image: Reference for receipt\n  - SKU Identifier: Unique variant code\n  - Variant Details: JSON {color: value, size: value, ...}\n  - Unit Price: Price at time of order\n  - Quantity: Units ordered\n  - Line Total: Unit price Ã— quantity\n  - Seller ID: Which seller owns this item\n  - Item Status: Initially same as order status\n  - Order Line Item ID: Unique identifier for this line\n```\n\n## Order Status Lifecycle\n\n### Complete Order Status Definitions\n\nTHE order SHALL progress through the following defined statuses:\n\n| Status | Definition | When Assigned | Customer Can See | Business Impact |\n|--------|-----------|---------------|------------------|----------------|\n| **PENDING_PAYMENT** | Order created, awaiting payment processing | Order creation completed | \"Processing your order\" | Inventory reserved, payment authorizing |\n| **CONFIRMED** | Payment successfully processed and verified | Payment cleared successfully | \"Order confirmed\" | Inventory committed, seller notified to fulfill |\n| **PROCESSING** | Seller is preparing and packing items | Seller marks order as accepted | \"Being prepared\" | Seller has responsibility to fulfill |\n| **SHIPPED** | Items dispatched from seller to carrier | Seller provides tracking information | \"On the way\" with tracking | Customer can monitor delivery progress |\n| **DELIVERED** | Carrier confirms delivery to address | Carrier notification received | \"Delivered\" with date | Review window opens, fulfillment complete |\n| **COMPLETED** | Order fully completed and past review window | 7 days after delivery + no pending actions | Historical record | Final status, no further changes |\n| **CANCELLED** | Order cancelled by customer or system | Customer request or timeout | \"Cancelled\" with reason | Inventory restored, refund initiated if paid |\n| **REFUND_REQUESTED** | Customer initiated refund/return request | Customer submits refund request | \"Return in progress\" | Awaiting seller or admin action |\n| **REFUNDED** | Refund processed and issued to customer | Refund approved and processed | \"Refunded\" with amount | Historical record |\n| **DISPUTE** | Order has unresolved dispute or chargeback | Dispute filed by either party | \"Under dispute\" | Admin intervention required |\n\n### Valid Status Transitions and Business Rules\n\n**From PENDING_PAYMENT:**\n- WHEN payment processing succeeds within 15 minutes, THE status SHALL transition to CONFIRMED\n- WHEN payment fails or times out after 15 minutes, THE status SHALL transition to CANCELLED\n- WHEN customer explicitly cancels within 5 minutes, THE status SHALL transition to CANCELLED\n- WHEN 15 minutes elapse without payment, THE system SHALL automatically transition to CANCELLED\n\n**From CONFIRMED:**\n- WHEN seller accepts order and begins processing, THE status SHALL transition to PROCESSING\n- WHEN customer requests cancellation within 1 hour of confirmation, THE status SHALL transition to CANCELLED (auto-approval if within window)\n- THE system SHALL NOT allow status change to CANCELLED after 1-hour window (customer must request refund instead)\n- WHEN seller marks items as ready for shipment, THE status SHALL transition to SHIPPED\n\n**From PROCESSING:**\n- WHEN seller marks items as shipped with tracking information, THE status SHALL transition to SHIPPED\n- WHEN customer requests cancellation, THE system SHALL route to REFUND_REQUESTED instead (cannot cancel in-process orders)\n- THE status SHALL NOT revert to CONFIRMED\n- WHEN 48 hours elapse without status update, THE system MAY escalate to admin attention\n\n**From SHIPPED:**\n- WHEN carrier confirms delivery, THE status SHALL transition to DELIVERED\n- WHEN carrier indicates delivery exception (undeliverable, returned), THE status SHALL transition to DISPUTE\n- WHEN 7 days elapse without delivery confirmation, THE system SHALL automatically transition to DELIVERED (assume delivery successful)\n\n**From DELIVERED:**\n- WHEN system timestamp reaches 7 days after delivery, THE status SHALL automatically transition to COMPLETED\n- WHEN customer initiates refund/return within 30 days, THE status SHALL transition to REFUND_REQUESTED\n- WHEN customer files dispute, THE status SHALL transition to DISPUTE\n\n**From COMPLETED:**\n- THE order SHALL remain in COMPLETED status (final state)\n- THE order SHALL only transition if dispute is opened (to DISPUTE status)\n- THE order records SHALL remain accessible indefinitely\n\n**From CANCELLED:**\n- THE order SHALL remain in CANCELLED status (final state)\n- THE order SHALL NOT transition to any other status\n- THE order SHALL be marked as historical record\n\n**Refund Status Path:**\n- FROM CONFIRMED â†’ REFUND_REQUESTED (customer initiates refund)\n- FROM DELIVERED â†’ REFUND_REQUESTED (customer initiates refund)\n- FROM REFUND_REQUESTED â†’ REFUNDED (refund approved and processed)\n- FROM REFUND_REQUESTED â†’ REFUND_REJECTED (refund denied)\n\n### Order Status Flow Diagram\n\n```mermaid\ngraph LR\n    A[\"Order Created<br/>PENDING_PAYMENT\"] -->|\"Payment Success<br/>within 15 min\"| B[\"CONFIRMED\"]\n    A -->|\"Payment Failed<br/>or Timeout\"| C[\"CANCELLED\"]\n    A -->|\"Customer Cancels<br/>within 5 min\"| C\n    A -->|\"15 min timeout<br/>no payment\"| C\n    \n    B -->|\"Seller Processes<br/>Order\"| D[\"PROCESSING\"]\n    B -->|\"Customer Cancels<br/>within 1 hour\"| C\n    B -->|\"Customer Requests<br/>Refund\"| E[\"REFUND_REQUESTED\"]\n    \n    D -->|\"Seller Ships<br/>Items\"| F[\"SHIPPED\"]\n    D -->|\"Customer Cancels<br/>Request Refund\"| E\n    \n    F -->|\"Delivery Confirmed<br/>or 7 day auto\"| G[\"DELIVERED\"]\n    F -->|\"Delivery Exception\"| H[\"DISPUTE\"]\n    \n    G -->|\"Customer Requests<br/>Refund within 30 days\"| E\n    G -->|\"7 days elapsed\"| I[\"COMPLETED\"]\n    G -->|\"Dispute Filed\"| H\n    \n    I -->|\"Within Return<br/>Window\"| J[\"RETURNED\"]\n    \n    E -->|\"Refund Approved\"| K[\"REFUNDED\"]\n    E -->|\"Refund Denied\"| L[\"REFUND_REJECTED\"]\n    \n    H -->|\"Dispute Resolved\"| M[\"RESOLVED\"]\n    \n    C -.->|\"Historical Record\"| N[\"Archived\"]\n    K -.->|\"Historical Record\"| N\n    L -.->|\"Historical Record\"| N\n    M -.->|\"Historical Record\"| N\n    I -.->|\"Historical Record\"| N\n```\n\n## Order Confirmation\n\n### Confirmation Requirements and Actions\n\nWHEN an order transitions to CONFIRMED status (payment successful), THE system SHALL execute the following sequence of actions:\n\n#### 1. Inventory Commitment\n\nWHEN order is confirmed, THE system SHALL atomically commit the inventory reduction:\n- THE inventory reduction SHALL be permanent and immediately reflected in real-time inventory\n- THE system SHALL update inventory status from \"RESERVED\" to \"ALLOCATED\" for order items\n- WHEN inventory is committed, THE system SHALL prevent double-counting of allocated inventory\n- THE system SHALL validate that inventory has not dropped below zero (fail-safe)\n\nIF inventory commitment fails (inventory became negative due to timing issue), THEN THE system SHALL:\n1. Immediately refund the customer payment\n2. Cancel the order\n3. Alert admin to investigate inventory discrepancy\n4. Notify customer of cancellation reason\n\n#### 2. Order Records and Timestamps\n\nWHEN confirming order, THE system SHALL:\n- Record confirmation timestamp (when payment was successfully processed)\n- Record exact amount charged to the customer\n- Create immutable order record marking this moment\n- Begin order fulfillment clock (tracking fulfillment SLA)\n\n#### 3. Seller Order Creation for Multi-Seller Orders\n\nWHEN order contains items from multiple sellers, THE system SHALL create individual seller orders:\n- THE system SHALL identify all distinct sellers in the order\n- FOR each seller, THE system SHALL create a separate seller-specific order record containing:\n  - Seller ID\n  - All items from this order belonging to this seller\n  - Order total apportioned to this seller's items only\n  - Customer delivery address (full address for fulfillment)\n  - Customer contact information (name, phone, email)\n  - Fulfillment deadline (typically 48 hours)\n- THE system SHALL maintain foreign key reference linking seller order to parent customer order\n- WHEN multiple items are from same seller, THE system SHALL consolidate into single seller order\n\n#### 4. Customer Notification\n\nWHEN order is confirmed, THE system SHALL immediately send confirmation email to customer:\n- THE email SHALL include:\n  - Order number (unique identifier for customer reference)\n  - Order date and time\n  - Complete list of ordered items with quantities and prices\n  - Order total with tax and shipping breakdown\n  - Delivery address\n  - Estimated delivery date\n  - Link to track order status in customer account\n  - Customer service contact information\n  - Expected fulfillment timeline (e.g., \"Seller will prepare within 48 hours\")\n- THE email SHALL be sent within 1 minute of order confirmation\n- THE system SHALL store email delivery confirmation in order record\n\n#### 5. Seller Notifications\n\nWHEN order is confirmed, THE system SHALL send notification to each affected seller:\n- THE notification SHALL include:\n  - Order number (unique identifier)\n  - All items from this seller in the order\n  - Order total for this seller's items only\n  - Customer delivery address (complete address for fulfillment)\n  - Customer contact name and phone\n  - Required fulfillment deadline (default: 48 hours from notification)\n  - Link to seller dashboard to view order details\n- WHEN multiple items from same seller are in order, THE system SHALL consolidate into single seller notification\n- THE system SHALL provide direct order acceptance action in notification\n\n#### 6. Order Timeline Recording\n\nWHEN order is confirmed, THE system SHALL record:\n- Order confirmation timestamp (exact moment)\n- Calculate and set expected fulfillment date (e.g., 48 hours from confirmation)\n- Calculate and set expected delivery date range (e.g., 5-7 business days from fulfillment)\n- Record fulfillment SLA deadlines for sellers\n\n## Order Details and Records\n\n### Complete Order Data Structure\n\nEach order record SHALL contain the following complete information:\n\n**Order Identification**\n```\nOrder ID: UUID (system-generated, immutable)\nOrder Number: ORD-YYYYMMDD-XXXXXX (human-readable, immutable)\nOrder Status: Current status from defined lifecycle\nOrder Timestamp: ISO 8601 (immutable creation time)\nLast Updated Timestamp: ISO 8601 (updated on status changes)\nOrder Version: Integer for concurrency control\n```\n\n**Customer Information**\n```\nCustomer ID: UUID reference to customer account\nCustomer Name: Full name at time of order\nCustomer Email: Email address at time of order\nCustomer Phone: Phone number if provided\nCustomer Account Status: Active/Suspended/etc at time of confirmation\n```\n\n**Delivery Information**\n```\nDelivery Address: Complete address record (immutable after order placed)\nDelivery Address Validated: Boolean (true if validated successfully)\nEstimated Delivery Date: Date range from selected shipping method\nActual Delivery Date: ISO 8601 (null until delivered)\nDelivery Instructions: Special handling requested by customer\nDelivery Status: From shipping system integration\n```\n\n**Pricing Information**\n```\nSubtotal Amount: Decimal with 2 places (item prices Ã— quantities)\nTax Amount: Decimal with 2 places (calculated from address)\nShipping Cost: Decimal with 2 places (null if free)\nDiscount Amount: Decimal with 2 places (null if no discount)\nTotal Amount: Decimal with 2 places (subtotal + tax + shipping - discount)\nCurrency: ISO 4217 currency code (default: USD)\n```\n\n**Payment Information**\n```\nPayment Status: PENDING, SUCCESSFUL, FAILED, REFUNDED\nPayment Method: CREDIT_CARD, DEBIT_CARD, WALLET, BANK_TRANSFER\nPayment Gateway Transaction ID: Identifier from payment processor\nPayment Timestamp: ISO 8601 (when payment was processed)\nPayment Amount: Decimal (amount charged)\nPayment Authorization Code: From payment processor\n```\n\n**Order Items (array)**\n```\nFor each Order Line Item:\n  - Line Item ID: UUID (unique per line item)\n  - Product ID: UUID (reference to product)\n  - Product Name: Text (product name at time of order)\n  - Product Image URL: Reference for receipt/display\n  - SKU Identifier: Unique variant code\n  - Variant Details: JSON object {color: value, size: value, ...}\n  - Unit Price: Decimal with 2 places (price at order time)\n  - Quantity: Integer (quantity ordered)\n  - Line Total: Decimal (unit price Ã— quantity)\n  - Seller ID: UUID (identifies which seller owns this item)\n  - Item Status: Mirrors order status for individual tracking\n  - Item Fulfillment Status: PENDING, PREPARED, SHIPPED, DELIVERED\n```\n\n**Seller References**\n```\nArray of Seller IDs (all sellers involved in this order)\nFor each seller in order:\n  - Seller ID: UUID\n  - Seller Name: Store name\n  - Items belonging to this seller: Array of line item IDs\n  - Seller Order Number: Unique identifier within seller's system\n  - Seller Commission Rate: Percentage applied at time of order\n```\n\n**Order Timeline**\n```\nCreated Timestamp: ISO 8601 (immutable, when order created)\nConfirmed Timestamp: ISO 8601 (when payment confirmed)\nProcessing Started Timestamp: ISO 8601 (when seller started processing, nullable)\nShipped Timestamp: ISO 8601 (when seller marked shipped, nullable)\nDelivered Timestamp: ISO 8601 (when delivery confirmed, nullable)\nCompleted Timestamp: ISO 8601 (when moved to COMPLETED status, nullable)\nCancelled Timestamp: ISO 8601 (if order was cancelled, nullable)\nLast Status Change Timestamp: ISO 8601 (most recent update)\n```\n\n**Order Metadata**\n```\nOrder Version: Integer (for concurrency control)\nOrder Type: STANDARD, PREORDER, etc.\nIs Gift: Boolean (affects packaging/messaging)\nGift Message: Text (nullable, for gift orders)\nPromo Codes Applied: Array (promotional codes used)\nPromo Discount Amount: Decimal (total discount from all promos)\nSpecial Instructions: Text (nullable, customer special requests)\nFulfillment SLA Deadline: ISO 8601 (when seller must ship by)\n```\n\n## Multiple Items Per Order\n\n### Multi-Seller Order Handling\n\nWHEN an order contains items from multiple sellers, THE system SHALL handle as follows:\n\n#### Order Consolidation\n\nWHEN a customer places single order with items from multiple sellers, THE system SHALL:\n- Create ONE customer order record containing all items regardless of seller\n- Include all items in order total regardless of seller\n- Apply single payment to customer (one charge)\n- Provide single delivery address that applies to all items\n- Generate single order confirmation email to customer\n\nTHE customer order SHALL represent the complete transaction from customer's perspective.\n\n#### Seller Order Decomposition\n\nWHEN order is confirmed, THE system SHALL decompose the customer order into multiple seller orders:\n- THE system SHALL create one seller order for each distinct seller\n- WHEN creating seller orders, THE system SHALL maintain foreign key reference to parent customer order\n- WHEN decomposing, THE system SHALL assign all items from specific seller to that seller's order\n- WHEN decomposing, THE system SHALL calculate seller's portion of order total (sum of seller's items only)\n- THE seller orders SHALL be independent fulfillment records but linked to customer order for tracking\n\n#### Inventory Deduction\n\nWHEN order is confirmed, THE system SHALL reduce inventory atomically:\n- THE system SHALL process all inventory deductions as single atomic transaction\n- THE inventory reduction SHALL NOT be partial (all items succeed or all fail)\n- WHEN any inventory check fails, THE system SHALL rollback entire order and return cart to customer\n- THE system SHALL provide customer with specific information about which items caused the failure\n- THE system SHALL offer option to remove failed items and retry checkout\n\n#### Payment and Pricing\n\nWHEN order has multiple sellers, THE system SHALL:\n- Collect single payment from customer\n- THE total payment SHALL be sum of all seller items\n- THE system SHALL track how much of total payment belongs to each seller\n- WHEN items have different tax rates, THE system SHALL apply correct tax per item based on item category\n- WHEN calculating commissions, THE system SHALL apply commission per seller portion of order\n\n#### Fulfillment Coordination\n\nWHEN order has items from multiple sellers, THE system SHALL:\n- Allow independent seller fulfillment workflows\n- WHEN seller A ships their items, THE system SHALL update only those items to SHIPPED status\n- WHEN all sellers have shipped, THE system SHALL update overall order status to SHIPPED\n- WHEN customer receives partial delivery from one seller, THE system SHALL track partial delivery state\n- WHEN any seller's shipment is delayed, THE system SHALL notify customer with updated delivery expectation\n- THE overall order status transitions only when all line items reach equivalent status\n\n#### Shipping Scenarios\n\nWHEN order has items from multiple sellers, THE customer MAY receive multiple shipments:\n- WHEN items are from different sellers in different locations, THE system SHALL process separate shipments\n- WHEN processing separate shipments, THE system SHALL provide customer with separate tracking information for each shipment\n- WHEN any seller's portion is delayed, THE system SHALL notify customer of revised delivery expectation\n- WHEN tracking shows multiple shipments, THE system SHALL display them as separate \"From [Seller Name]\" in order details\n\n### Multi-Seller Example Workflow\n\nExample Scenario:\n- Customer orders 4 items total:\n  - Items A and B from Seller 1\n  - Item C from Seller 2  \n  - Item D from Seller 3\n  - Order Total: $150.00\n\nTHE system SHALL:\n1. Create ONE customer order (ORD-20240115-000001) with all 4 items, total $150.00\n2. Charge customer $150.00 in single payment\n3. Create three seller orders:\n   - Seller Order 1: Items A, B - seller's portion of $150 (e.g., $75)\n   - Seller Order 2: Item C - seller's portion (e.g., $40)\n   - Seller Order 3: Item D - seller's portion (e.g., $35)\n4. Notify each seller independently to prepare their items\n5. Allow each seller to ship independently on their own schedule\n6. Track three separate shipments with three tracking numbers\n7. Show customer all three shipments in single order\n8. Mark overall order as SHIPPED when all sellers have shipped\n9. Mark overall order as DELIVERED when all items are delivered (or 7 days pass)\n\n## Order Fulfillment\n\n### Seller Fulfillment Workflow\n\nWHEN an order is confirmed, sellers are responsible for the following fulfillment process:\n\n#### Phase 1: Order Acceptance (Deadline: 24 hours)\n\nWHEN seller receives order notification, THE seller SHALL review order details.\n\nWHEN seller reviews order, THE seller SHALL verify:\n- All items are in stock and ready to prepare\n- All items match order specifications\n- Delivery address is valid\n- No order conflicts or issues\n\nWHEN seller is ready to proceed, THE seller SHALL accept the order (mark as accepted in dashboard).\n\nIF seller does not accept within 24 hours, THEN:\n- THE system SHALL send reminder notification to seller at 12-hour mark\n- THE system SHALL automatically cancel the order and initiate refund after 24 hours\n- THE system SHALL notify customer of seller non-acceptance\n- THE system SHALL flag seller for performance tracking\n\n#### Phase 2: Item Preparation (Deadline: 48 hours from order confirmation)\n\nWHEN seller accepts order, THE order status SHALL change from CONFIRMED to PROCESSING.\n\nDURING processing, THE seller SHALL prepare all items for shipment:\n- Pick items from inventory\n- Verify items match order specifications (correct SKU, color, size, options)\n- Quality check items for defects or issues\n- Package items securely\n- Prepare shipping documents\n\nWHEN seller completes item preparation, THE seller SHALL validate:\n- All ordered items are present and correct\n- Items match specifications (correct color, size, options)\n- Items are in good condition\n- Packaging is secure and protective\n\nIF validation reveals issues, THEN THE seller SHALL:\n- Update customer with revised delivery date or refund offer\n- Allow customer to accept delay or request cancellation\n- Proceed with corrective action\n\n#### Phase 3: Shipment Initiation (Deadline: 48 hours from order confirmation)\n\nWHEN seller is ready to ship, THE seller SHALL input tracking information into system:\n- Provide carrier name (e.g., FedEx, UPS, DHL)\n- Provide tracking number\n- Provide estimated delivery date\n- Upload shipping label or proof of shipment\n\nWHEN seller provides tracking information, THE system SHALL:\n- Change order status to SHIPPED\n- Record shipment timestamp\n- Notify customer immediately with tracking details\n- Provide customer with tracking link\n\nIF seller provides invalid tracking number, THEN THE system SHALL:\n- Reject the shipment submission\n- Display error message\n- Allow seller to correct and resubmit\n\n#### Phase 4: Shipment Tracking\n\nWHEN order status is SHIPPED, THE system SHALL:\n- Integrate with carrier API to track delivery progress\n- Receive periodic updates from carrier\n- Update order tracking status\n- Provide customer with current location and estimated delivery\n\nFOR detailed tracking information, refer to [Shipping and Tracking Document](./09-shipping-tracking.md).\n\n### Fulfillment Requirements\n\nTHE following requirements apply to order fulfillment:\n\n- WHEN seller accepts order, THE seller SHALL fulfill within 2 business days (48 hours typical)\n- WHEN fulfillment deadline passes, THE system SHALL send alert to admin for follow-up\n- WHEN seller repeatedly misses fulfillment deadlines (>3 times in 30 days), THE system SHALL suspend seller account\n- WHEN items cannot be fulfilled, THE seller SHALL immediately notify customer with reason\n- WHEN seller must cancel fulfillment, THE system SHALL initiate refund process automatically\n- THE seller SHALL provide tracking number before order status changes to SHIPPED\n- WHEN seller provides invalid tracking number, THE system SHALL request correction before accepting shipment\n\n### Fulfillment Status Management\n\nEACH order item SHALL track independent fulfillment status:\n\n| Status | Description | Seller Action | Next Status |\n|--------|-------------|---------------|-------------|\n| PENDING | Order accepted, awaiting preparation | Pick and prepare items | PREPARED |\n| PREPARED | Items prepared and verified | Initiate shipment with tracking | SHIPPED |\n| SHIPPED | Items handed to carrier with tracking | System monitors delivery | DELIVERED |\n| DELIVERED | Items received by customer | Confirmed by carrier | Complete |\n| EXCEPTION | Issue with shipment | Seller resolves with carrier | DELIVERED or Resolved |\n\nWHEN order has items from multiple sellers, EACH seller's items progress through fulfillment status independently.\n\n## Seller Order View\n\n### Seller Order Information Access\n\nWHEN a seller views orders in their seller dashboard, THE seller SHALL see ONLY orders containing their products.\n\nWHEN seller attempts to view order not containing their products, THE system SHALL deny access with message \"You don't have permission to view this order\".\n\nTHE seller SHALL NOT see:\n- Orders that don't contain their products\n- Orders from other sellers\n- Customer personal information beyond what's necessary for fulfillment\n- Other sellers' items in consolidated orders\n- Commission amounts or financial details of other sellers\n\n### Seller-Visible Order Information\n\nWHEN seller accesses an order, THE seller SHALL see:\n\n**Order Summary Section**\n```\nOrder Number: Unique identifier for reference\nOrder Status: Current status (CONFIRMED, PROCESSING, SHIPPED, etc.)\nItems from this seller: Count and list (not items from other sellers)\nOrder Total for Seller's Items: Sum of this seller's item prices only\nOrder Timestamp: When customer placed order\nOrder Confirmation Timestamp: When payment was processed\n```\n\n**Customer Delivery Information (for fulfillment)**\n```\nCustomer Name: Full name provided at order\nCustomer Phone Number: For delivery coordination\nDelivery Address: Complete address (street, city, state, ZIP, country)\nDelivery Instructions: Any special handling customer requested\nEstimated Delivery Date: Target delivery window\nShipping Method: Selected carrier service (e.g., FedEx Standard)\n```\n\n**Order Items (seller's items only)**\n```\nFor each item from this seller:\n  - Product Name: Display name\n  - SKU Identifier: Unique variant code\n  - Variant Details: Color, size, options, etc.\n  - Unit Price: Price per unit at time of order\n  - Quantity: Units ordered\n  - Item Subtotal: Unit price Ã— quantity\n  - Item Status: Current fulfillment status\n  - Item Special Instructions: Any notes about this item\n```\n\n**Seller Action History**\n```\nWhen order was accepted: Timestamp\nWhen seller marked as processing: Timestamp\nWhen seller marked as shipped: Timestamp and tracking number\nCurrent fulfillment status: PENDING, PROCESSING, SHIPPED, DELIVERED\nTracking number (if shipped): Full tracking number with carrier\n```\n\n**Notes and Communication**\n```\nSeller Notes: Internal notes visible only to this seller\nCustomer Message: Any message from customer about this order\nMessages from Customer: Communication thread\n```\n\n### Seller Order Management Operations\n\nTHE seller SHALL be able to perform the following actions on orders:\n\n#### 1. Accept/Acknowledge Order\n\nWHEN seller receives order notification, THE seller SHALL click \"Accept Order\" within 24 hours.\n\nWHEN order is accepted, THE system SHALL:\n- Record acceptance timestamp\n- Change order status from CONFIRMED to PROCESSING\n- Notify customer that seller is preparing the order\n- Start fulfillment SLA timer (48-hour deadline)\n\nIF seller does not accept within 24 hours, THEN:\n- THE system SHALL automatically cancel the order\n- THE system SHALL initiate refund to customer\n- THE system SHALL notify seller of timeout\n\n#### 2. Update Fulfillment Status\n\nWHEN items are prepared, THE seller SHALL mark items as \"PREPARED\":\n- THE system SHALL record preparation timestamp\n- THE system SHALL indicate items are ready for shipment\n\nWHEN items are ready to ship, THE seller SHALL upload tracking information:\n- Provide carrier name\n- Provide tracking number\n- Provide estimated delivery date\n- THE system SHALL validate tracking format\n\nWHEN tracking is uploaded, THE system SHALL:\n- Automatically change status to SHIPPED\n- Notify customer with tracking details\n- Provide tracking link to carrier\n- Record shipment timestamp\n\n#### 3. Provide Tracking Information\n\nWHEN seller ships items, THE seller SHALL provide:\n- Carrier name (FedEx, UPS, DHL, USPS, etc.)\n- Tracking number (must be valid format)\n- Expected delivery date\n- Shipping label or proof of shipment\n\nTHE system SHALL validate tracking information:\n- Verify tracking number format\n- Verify carrier is recognized\n- Attempt to query carrier API\n\nIF tracking validation fails, THEN THE system SHALL:\n- Reject the shipment\n- Display validation error\n- Allow seller to correct and resubmit\n\n#### 4. Request Support or Escalate\n\nWHEN seller encounters issues, THE seller SHALL be able to:\n- Message customer for clarification (delivery address, special requests)\n- Contact admin support through dashboard\n- Request admin intervention for special circumstances\n- Request extension for fulfillment if needed (with reason)\n\n### Seller Order Notifications\n\nTHE system SHALL notify sellers of the following events:\n\n| Event | Timing | Notification Type |\n|-------|--------|-------------------|\n| New Order Received | Immediately | Email + Dashboard |\n| Order Awaiting Acceptance | After 12 hours if not accepted | Email reminder |\n| Order Timeout (not accepted after 24h) | After 24 hours | Email + Auto-cancel order |\n| Customer Messages | Real-time | Dashboard + Email |\n| Order Cancellation Request | When initiated | Email notification |\n| Refund Request | When initiated | Email + Dashboard |\n| Review Posted | When customer posts | Email + Dashboard |\n| Fulfillment Deadline Approaching | 24 hours before deadline | Email reminder |\n| Low Stock Alert | When stock falls below threshold | Email + Dashboard |\n\n### Multi-Seller Order Visibility\n\nWHEN an order contains items from multiple sellers, THE system SHALL:\n- Create independent seller order views for each seller\n- Ensure each seller sees ONLY their items and relevant fulfillment info\n- Prevent sellers from seeing other sellers' items or pricing\n- Allow independent fulfillment by each seller\n- Track fulfillment progress separately per seller\n- Notify customer with all tracking numbers when multiple shipments occur\n- Show multi-seller order as consolidated view to customer\n\n---\n\n> *Developer Note: This document defines **business requirements only**. All technical implementations (architecture, APIs, database design, etc.) are at the discretion of the development team.*"
