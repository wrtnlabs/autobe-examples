/// Order header capturing a single buyer-facing order. Stores buyer
/// reference, shipping address snapshot, pricing breakdown, and lifecycle
/// timestamps. Modified to avoid cascading delete cycles with shipments:
/// primary shipment is represented via shipment records rather than a direct
/// foreign key on the order to prevent circular cascade delete issues.
/// Related entities: {@link shopping_mall_order_items}, {@link
/// shopping_mall_payments}, {@link shopping_mall_refund_requests}, {@link
/// shopping_mall_shipments}.
///
/// @namespace Orders
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_orders {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Belonged buyer customer. {@link shopping_mall_customer.id}
  shopping_mall_customer_id String
  
  /// Reference to shipping address snapshot source. {@link
  /// shopping_mall_addresses.id}
  shipping_address_id String?
  
  /// Business-facing unique order number (human-readable).
  order_number String
  
  /// Origin channel of the order (web, mobile, api) for reporting.
  order_source String?
  
  /// JSON-serialized shipping address snapshot captured at order time to
  /// preserve historical accuracy. Consider migrating to native JSON/JsonB
  /// where supported.
  shipping_address_snapshot String
  
  /// Sum of line item amounts before taxes and shipping.
  subtotal_amount Float
  
  /// Shipping fee applied to the order.
  shipping_amount Float
  
  /// Total tax amount for the order.
  tax_amount Float
  
  /// Sum of discounts applied to the order (if any).
  discount_amount Float?
  
  /// Final charged amount for the order (subtotal + shipping + tax -
  /// discounts).
  total_amount Float
  
  /// Currency code (ISO) used for this order.
  currency String
  
  /// Order lifecycle status (Created, Payment Pending, Paid, Processing,
  /// Shipped, Delivered, Cancelled, Refunded, Closed).
  status String
  
  /// Payment business state (authorized, captured, failed, refunded).
  payment_state String
  
  /// Reservation expiry timestamp for inventory holds related to this order.
  reserved_until DateTime?
  
  /// Timestamp when the order was created/placed.
  placed_at DateTime
  
  /// Timestamp when payment was captured for the order.
  paid_at DateTime?
  
  /// Timestamp when the order lifecycle closed (finalized).
  closed_at DateTime?
  
  /// Free-text note provided by the customer; searchable via GIN index.
  customer_note String?
  
  /// Internal note for support/admin use; not shown to customers.
  internal_note String?
  
  /// Record creation timestamp.
  created_at DateTime
  
  /// Record last update timestamp.
  updated_at DateTime
  
  /// Soft-delete timestamp for the order (if applicable).
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  customer shopping_mall_customer @relation(fields: [shopping_mall_customer_id], references: [id], onDelete: Cascade)
  shippingAddress shopping_mall_addresses? @relation(fields: [shipping_address_id], references: [id], onDelete: Cascade)
  
  shopping_mall_order_items shopping_mall_order_items[]
  shopping_mall_payments shopping_mall_payments[]
  shopping_mall_refund_requests shopping_mall_refund_requests[]
  shopping_mall_shipments shopping_mall_shipments[]
  
  @@index([shipping_address_id])
  
  @@unique([order_number])
  @@index([shopping_mall_customer_id, created_at])
  @@index([status, created_at])
}

/// Order line items that belong to an order. Each record captures a snapshot
/// of the SKU and pricing at order time for historical accuracy. Links to
/// {@link shopping_mall_orders.id} and optionally to the live {@link
/// shopping_mall_skus.id} and {@link shopping_mall_seller.id} for seller
/// attribution.
///
/// @namespace Orders
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_order_items {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Belonged order header {@link shopping_mall_orders.id}.
  shopping_mall_order_id String
  
  /// Referenced SKU for cross-reference {@link shopping_mall_skus.id}.
  /// Nullable if SKU removed; keep snapshot for history.
  shopping_mall_sku_id String?
  
  /// Seller that owns this line's SKU {@link shopping_mall_seller.id}.
  shopping_mall_seller_id String
  
  /// Optional shipment reference for this order line {@link
  /// shopping_mall_shipments.id}.
  shipment_id String?
  
  /// JSON-serialized snapshot of SKU fields (title, selected attributes,
  /// images) at time of order for historical display.
  sku_snapshot String
  
  /// Product/SKU title snapshot for quick display and indexing.
  name_snapshot String
  
  /// Quantity ordered for this line item.
  quantity Int
  
  /// Unit price charged at order time.
  unit_price Float
  
  /// Quantity * unit_price before line-level discounts and taxes.
  line_total Float
  
  /// Tax amount applied to this line.
  tax_amount Float?
  
  /// Currency code used for this line.
  currency String
  
  /// Fulfillment status for the line (Pending, Processing, Shipped, Delivered,
  /// Returned, Refunded).
  status String
  
  /// Record creation timestamp.
  created_at DateTime
  
  /// Record last update timestamp.
  updated_at DateTime
  
  /// Soft-delete timestamp for the order item.
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  order shopping_mall_orders @relation(fields: [shopping_mall_order_id], references: [id], onDelete: Cascade)
  sku shopping_mall_skus? @relation(fields: [shopping_mall_sku_id], references: [id], onDelete: Cascade)
  seller shopping_mall_seller @relation(fields: [shopping_mall_seller_id], references: [id], onDelete: Cascade)
  shipment shopping_mall_shipments? @relation(fields: [shipment_id], references: [id], onDelete: Cascade)
  
  shopping_mall_refund_requests shopping_mall_refund_requests[]
  
  @@index([shopping_mall_sku_id])
  @@index([shipment_id])
  
  @@index([shopping_mall_order_id, created_at])
  @@index([shopping_mall_seller_id, status])
}

/// Payment records tied to orders. Records authorization, capture, refund
/// attempts, external provider ids and minimal payment metadata for
/// reconciliation. Links to {@link shopping_mall_orders.id} and payer {@link
/// shopping_mall_customer.id}.
///
/// @namespace Orders
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_payments {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Related order {@link shopping_mall_orders.id}.
  shopping_mall_order_id String
  
  /// Paying customer reference {@link shopping_mall_customer.id}.
  shopping_mall_customer_id String
  
  /// Amount attempted or captured for this payment event.
  amount Float
  
  /// Currency code for the payment.
  currency String
  
  /// Payment method label (card, wallet, bank_transfer).
  method String
  
  /// External payment provider name.
  provider String?
  
  /// Provider-side unique payment identifier for reconciliation.
  provider_payment_id String?
  
  /// Payment status (authorized, captured, failed, refunded).
  status String
  
  /// Timestamp when authorization occurred.
  authorized_at DateTime?
  
  /// Timestamp when capture occurred.
  captured_at DateTime?
  
  /// Timestamp when refund was processed for this payment.
  refunded_at DateTime?
  
  /// JSON-serialized minimal metadata for provider webhooks or reconciliation
  /// context.
  metadata String?
  
  /// Record creation timestamp.
  created_at DateTime
  
  /// Record last update timestamp.
  updated_at DateTime
  
  //----
  // RELATIONS
  //----
  order shopping_mall_orders @relation(fields: [shopping_mall_order_id], references: [id], onDelete: Cascade)
  customer shopping_mall_customer @relation(fields: [shopping_mall_customer_id], references: [id], onDelete: Cascade)
  
  @@unique([provider_payment_id])
  @@index([shopping_mall_order_id, status])
  @@index([shopping_mall_customer_id, created_at])
}

/// Refund and cancellation request records related to orders or individual
/// order items. Tracks requester (customer or supportAgent), requested
/// amount, reason, processing status and decision metadata. Added nullable
/// supportAgent requester FK to preserve referential integrity for
/// agent-initiated requests.
///
/// @namespace Orders
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_refund_requests {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Associated order. {@link shopping_mall_orders.id}.
  shopping_mall_order_id String
  
  /// Optional line-level association when refund targets specific item. {@link
  /// shopping_mall_order_items.id}.
  shopping_mall_order_item_id String?
  
  /// User who requested refund when requester is a customer. {@link
  /// shopping_mall_customer.id}. Nullable when requester is a supportAgent or
  /// system actor.
  requester_id String?
  
  /// Optional supportAgent who requested or created the refund on behalf of a
  /// customer. {@link shopping_mall_supportagent.id}.
  shopping_mall_supportagent_requester_id String?
  
  /// Admin who processed the refund decision. {@link shopping_mall_admin.id}.
  decision_by_admin_id String?
  
  /// Amount requested for refund in order currency.
  requested_amount Float
  
  /// Currency code for the refund request.
  currency String
  
  /// Free-text reason supplied by requester; searchable with GIN.
  reason String?
  
  /// Refund request status (pending, approved, denied, processed).
  status String
  
  /// Timestamp when refund request was created.
  initiated_at DateTime
  
  /// Timestamp when refund was processed/completed.
  processed_at DateTime?
  
  /// Internal processing notes for support/admins.
  processing_notes String?
  
  /// Record creation timestamp.
  created_at DateTime
  
  /// Record last update timestamp.
  updated_at DateTime
  
  //----
  // RELATIONS
  //----
  order shopping_mall_orders @relation(fields: [shopping_mall_order_id], references: [id], onDelete: Cascade)
  orderItem shopping_mall_order_items? @relation(fields: [shopping_mall_order_item_id], references: [id], onDelete: Cascade)
  requester shopping_mall_customer? @relation(fields: [requester_id], references: [id], onDelete: Cascade)
  supportRequester shopping_mall_supportagent? @relation(fields: [shopping_mall_supportagent_requester_id], references: [id], onDelete: Cascade)
  decisionBy shopping_mall_admin? @relation(fields: [decision_by_admin_id], references: [id], onDelete: Cascade)
  
  @@index([shopping_mall_order_item_id])
  @@index([shopping_mall_supportagent_requester_id], map: "shopping_mall_refund_requests_shopping_mall_supportage_d83db4da")
  @@index([decision_by_admin_id])
  
  @@index([shopping_mall_order_id, status])
  @@index([requester_id, initiated_at])
}