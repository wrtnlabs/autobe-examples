import { Controller } from "@nestjs/common";
import { TypedRoute, TypedParam, TypedBody } from "@nestia/core";
import typia, { tags } from "typia";
import { postCommunityPortalMemberPostsPostIdReports } from "../../../../../providers/postCommunityPortalMemberPostsPostIdReports";
import { MemberAuth } from "../../../../../decorators/MemberAuth";
import { MemberPayload } from "../../../../../decorators/payload/MemberPayload";

import { ICommunityPortalReport } from "../../../../../api/structures/ICommunityPortalReport";

@Controller("/communityPortal/member/posts/:postId/reports")
export class CommunityportalMemberPostsReportsController {
  /**
   * Create a report for a post (community_portal_reports).
   *
   * Create a moderation report for a post and persist it to
   * community_portal_reports.
   *
   * Purpose and overview: This endpoint allows an authenticated member to
   * report a post. The API inserts a record into community_portal_reports
   * linking to the target post via post_id. Reports are intended to be
   * auditable evidence and should remain even if the referenced post or users
   * are later removed.
   *
   * Security and permissions: Caller must be authenticated as a member. The
   * server sets reporter_user_id from the authenticated context. The
   * implementation must not expose sensitive fields (password_hash, secrets) in
   * the response. Access control ensures the reporter has visibility to the
   * target post.
   *
   * Validation and behavior:
   *
   * - Validate path parameter postId is a UUID and that the post exists;
   *   otherwise respond 404.
   * - Request body MUST include reason_code (controlled vocabulary enforced at
   *   application level). Optional fields: reason_text, is_urgent (boolean),
   *   severity, reporter_contact_email (email format validated if provided).
   * - On success return HTTP 201 Created with the created report resource.
   *
   * Errors: 400 Bad Request (validation), 401 Unauthorized (not authenticated),
   * 404 Not Found (post not found), 409 Conflict (duplicate-report policy if
   * implemented).
   *
   * @param connection
   * @param postId Target post's ID (community_portal_posts.id)
   * @param body Report creation payload: required: reason_code. Optional:
   *   reason_text, is_urgent (boolean), severity, reporter_contact_email. The
   *   server sets reporter_user_id from the authenticated member.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Post()
  public async create(
    @MemberAuth()
    member: MemberPayload,
    @TypedParam("postId")
    postId: string & tags.Format<"uuid">,
    @TypedBody()
    body: ICommunityPortalReport.ICreate,
  ): Promise<ICommunityPortalReport> {
    try {
      return await postCommunityPortalMemberPostsPostIdReports({
        member,
        postId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
