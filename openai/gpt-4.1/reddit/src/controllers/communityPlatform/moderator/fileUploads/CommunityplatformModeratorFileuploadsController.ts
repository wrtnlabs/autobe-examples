import { Controller } from "@nestjs/common";
import { TypedRoute, TypedParam, TypedBody } from "@nestia/core";
import typia, { tags } from "typia";
import { putCommunityPlatformModeratorFileUploadsFileUploadId } from "../../../../providers/putCommunityPlatformModeratorFileUploadsFileUploadId";
import { ModeratorAuth } from "../../../../decorators/ModeratorAuth";
import { ModeratorPayload } from "../../../../decorators/payload/ModeratorPayload";
import { deleteCommunityPlatformModeratorFileUploadsFileUploadId } from "../../../../providers/deleteCommunityPlatformModeratorFileUploadsFileUploadId";

import { ICommunityPlatformFileUpload } from "../../../../api/structures/ICommunityPlatformFileUpload";

@Controller("/communityPlatform/moderator/fileUploads/:fileUploadId")
export class CommunityplatformModeratorFileuploadsController {
  /**
   * Update metadata or logical status of an existing file upload in
   * community_platform_file_uploads.
   *
   * Authenticated members, moderators, or admins use this endpoint to update
   * non-binary metadata for a previously uploaded file. Allowed updates may
   * include renaming the file, updating the status ('active', 'deleted',
   * 'archived'), or changing the associated public URL when the file is moved
   * in storage. The file upload record is uniquely identified by fileUploadId
   * (UUID).
   *
   * This operation enforces strict permission checks: a member may only update
   * their own uploads; moderators and admins may update any file within their
   * scope. Attempting to update the status to 'deleted' marks the file as
   * soft-deleted and prevents further display/association but does not
   * physically remove stored content (to preserve integrity and audit). Updated
   * file uploads retain all prior relationships to posts, comments,
   * communities, or profiles unless deleted.
   *
   * Security requirements and audit protocols are enforced at every update,
   * ensuring the action is logged with member or role details. Related APIs
   * include endpoints for deleting file associations from posts or communities
   * and for retrieving file metadata by id.
   *
   * @param connection
   * @param fileUploadId Unique identifier of the file upload to update.
   * @param body Fields to update within the file upload metadata such as
   *   filename, status, or URL. Only non-binary changes allowed; actual
   *   storage/move/removal is out-of-band.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Put()
  public async update(
    @ModeratorAuth()
    moderator: ModeratorPayload,
    @TypedParam("fileUploadId")
    fileUploadId: string & tags.Format<"uuid">,
    @TypedBody()
    body: ICommunityPlatformFileUpload.IUpdate,
  ): Promise<ICommunityPlatformFileUpload> {
    try {
      return await putCommunityPlatformModeratorFileUploadsFileUploadId({
        moderator,
        fileUploadId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Permanently erase a file upload record from the platform database
   * (community_platform_file_uploads).
   *
   * The purpose of this operation is to delete a file upload entry from the
   * community_platform_file_uploads table, which tracks all files users have
   * uploaded to the platform (e.g., profile pictures, post images, community
   * banners/icons). The operation takes a fileUploadId as a path parameter and
   * will remove the associated row. This includes enforcing referential
   * integrity, meaning files used in banners, post images, or community images
   * are also removed if they lose their reference, according to onDelete:
   * Cascade.
   *
   * File records contain metadata for file location (storage_key, url),
   * ownership (uploaded_by_member_id), MIME type, and status (active, deleted).
   * The field 'deleted_at' is updated to the current timestamp when a soft
   * deletion occurs; for hard delete, the row is removed entirely. Deleting an
   * upload is a privileged action: only a moderator or admin may erase a file.
   * The operation ensures audit logging and may trigger further cleanups in
   * related image or post tables.
   *
   * Related operations include uploading a new file (POST), restoring
   * (undelete) a soft-deleted file, and listing files for a user or community.
   * Validation includes ensuring the fileUploadId exists, the user has correct
   * role and ownership or admin rights, and that the file is not currently
   * required for non-deletable key entities. Errors include attempting to
   * delete files still referenced as essential in the schema (e.g., a current
   * banner image), lack of permission, or not found (404).
   *
   * @param connection
   * @param fileUploadId Unique identifier for the file upload record to be
   *   deleted, must be UUID format.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Delete()
  public async erase(
    @ModeratorAuth()
    moderator: ModeratorPayload,
    @TypedParam("fileUploadId")
    fileUploadId: string & tags.Format<"uuid">,
  ): Promise<void> {
    try {
      return await deleteCommunityPlatformModeratorFileUploadsFileUploadId({
        moderator,
        fileUploadId,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
