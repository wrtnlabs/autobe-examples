import { Controller } from "@nestjs/common";
import { TypedRoute, TypedParam, TypedBody } from "@nestia/core";
import typia, { tags } from "typia";
import { patchShoppingMallCustomerOrdersOrderIdShipments } from "../../../../../providers/patchShoppingMallCustomerOrdersOrderIdShipments";
import { CustomerAuth } from "../../../../../decorators/CustomerAuth";
import { CustomerPayload } from "../../../../../decorators/payload/CustomerPayload";
import { getShoppingMallCustomerOrdersOrderIdShipmentsShipmentId } from "../../../../../providers/getShoppingMallCustomerOrdersOrderIdShipmentsShipmentId";

import { IPageIShoppingMallOrderShipment } from "../../../../../api/structures/IPageIShoppingMallOrderShipment";
import { IShoppingMallOrderShipment } from "../../../../../api/structures/IShoppingMallOrderShipment";

@Controller("/shoppingMall/customer/orders/:orderId/shipments")
export class ShoppingmallCustomerOrdersShipmentsController {
  /**
   * Retrieve all shipment status records for a specific order
   * (shopping_mall_order_shipments table).
   *
   * Retrieve a paginated, filterable list of all shipment records for a
   * specified order. Each record includes carrier, tracking number, shipping
   * status, shipment number, timestamps (dispatched, delivered, etc.), and
   * remarks. This operation is mapped to the shopping_mall_order_shipments
   * table and supports both simple and split-shipment order models (including
   * multiple sellers). The API allows users to check real-time shipment status
   * updates and may integrate with third-party carrier APIs for latest tracking
   * data.
   *
   * Authorization and data visibility rules are strictly enforced: customers
   * may query only their own orders, sellers get access to shipments involving
   * their products, and admins access all shipments. The request may include
   * advanced filtering (e.g., by shipment status), pagination, and sorting
   * (default: by creation date descending).
   *
   * Error cases (such as unauthorized, not found, or order without shipments)
   * are surfaced with clear, actionable messages. This endpoint should be used
   * in concert with order listing, fulfillment, and order detail APIs for a
   * complete fulfillment tracking workflow.
   *
   * @param connection
   * @param orderId Order ID for which all shipment records should be listed.
   * @param body Filtering and pagination options for shipment status retrieval
   *   (optional).
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Patch()
  public async index(
    @CustomerAuth()
    customer: CustomerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IShoppingMallOrderShipment.IRequest,
  ): Promise<IPageIShoppingMallOrderShipment> {
    try {
      return await patchShoppingMallCustomerOrdersOrderIdShipments({
        customer,
        orderId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Retrieve detailed information for a specific order shipment
   * (shopping_mall_order_shipments).
   *
   * Retrieve a specific shipment's tracking and delivery status within an
   * order. This operation allows customers to view the carrier, tracking
   * number, and current status (pending, shipped, in transit, out for delivery,
   * delivered, returned, cancelled, etc.) for any shipment that is part of
   * their placed order.
   *
   * Sellers use this endpoint to verify which shipments have been dispatched,
   * in progress, or completed. For multi-seller or split-shipment orders, this
   * enables visibility into each parcel's progress and any relevant remarks or
   * failures.
   *
   * Admins may use this operation for support, troubleshooting, and compliance
   * checkingâ€”especially when reviewing issues such as failed delivery, returns,
   * or customer escalations. Access to shipment detail is role-restricted:
   * customers may view only their own orders, sellers only shipments of their
   * products, and admins have visibility over all records. Security checks
   * based on order and user relationships are implemented in business logic.
   *
   * All returned data is aligned with the shopping_mall_order_shipments schema,
   * including carrier, tracking_number, status, timestamps, and remarks.
   *
   * @param connection
   * @param orderId Unique identifier of the target order containing the
   *   shipment
   * @param shipmentId Unique identifier of the shipment within the specified
   *   order
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Get(":shipmentId")
  public async at(
    @CustomerAuth()
    customer: CustomerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedParam("shipmentId")
    shipmentId: string & tags.Format<"uuid">,
  ): Promise<IShoppingMallOrderShipment> {
    try {
      return await getShoppingMallCustomerOrdersOrderIdShipmentsShipmentId({
        customer,
        orderId,
        shipmentId,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
