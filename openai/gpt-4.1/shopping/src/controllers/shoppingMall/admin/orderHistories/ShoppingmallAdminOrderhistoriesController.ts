import { Controller } from "@nestjs/common";
import { TypedRoute, TypedBody, TypedParam } from "@nestia/core";
import typia, { tags } from "typia";
import { patchShoppingMallAdminOrderHistories } from "../../../../providers/patchShoppingMallAdminOrderHistories";
import { AdminAuth } from "../../../../decorators/AdminAuth";
import { AdminPayload } from "../../../../decorators/payload/AdminPayload";
import { getShoppingMallAdminOrderHistoriesOrderHistoryId } from "../../../../providers/getShoppingMallAdminOrderHistoriesOrderHistoryId";
import { putShoppingMallAdminOrderHistoriesOrderHistoryId } from "../../../../providers/putShoppingMallAdminOrderHistoriesOrderHistoryId";

import { IPageIShoppingMallOrderHistory } from "../../../../api/structures/IPageIShoppingMallOrderHistory";
import { IShoppingMallOrderHistory } from "../../../../api/structures/IShoppingMallOrderHistory";

@Controller("/shoppingMall/admin/orderHistories")
export class ShoppingmallAdminOrderhistoriesController {
  /**
   * Search, filter, and paginate order history snapshots for customer service
   * and auditing.
   *
   * Retrieve a paginated list of historical snapshots for orders across the
   * shopping mall platform, utilizing the shopping_mall_order_histories table.
   * This operation exposes advanced search and filtering capabilities for order
   * cancellation, refund, escalation, or compliance snapshot records, which
   * enable users and administrators to trace actions and reconstruct an order's
   * timeline.
   *
   * The endpoint supports query parameters to filter by snapshot type (such as
   * 'cancellation', 'refund', 'escalation', or 'appeal'), current or historical
   * order status, date range, and initiator. Customers will only be able to
   * access their own order histories, while sellers may view histories related
   * to their fulfillments, and admins may audit all records regardless of
   * ownership. Search results are presented in descending date order for
   * transparency.
   *
   * Access is governed by role-based permissions, with customers restricted to
   * self-service, sellers to the orders they are responsible for, and admins
   * having full search/audit coverage. Results reflect the complete
   * audit/timepoint context for each service milestone as defined by the
   * schema.
   *
   * @param connection
   * @param body Search/filtering criteria for retrieving order history
   *   snapshots, including snapshot type, order status, actor info, and
   *   pagination controls.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Patch()
  public async index(
    @AdminAuth()
    admin: AdminPayload,
    @TypedBody()
    body: IShoppingMallOrderHistory.IRequest,
  ): Promise<IPageIShoppingMallOrderHistory.ISummary> {
    try {
      return await patchShoppingMallAdminOrderHistories({
        admin,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Retrieve a specific order history snapshot by its unique ID.
   *
   * Fetch the full detail for a single order history snapshot from the
   * shopping_mall_order_histories table, referenced by its unique
   * orderHistoryId. This endpoint is designed for scenarios where users,
   * sellers, or administrators need to review the exact state of an order at a
   * service milestoneâ€”such as a cancellation, refund, or appeal event.
   *
   * Upon providing the orderHistoryId, the operation returns all stored audit,
   * reason, and context information for that milestone, including total order
   * amount, status, and any business or compliance comments. This detail can
   * support customer self-service, seller dispute workflows, or admin legal
   * review. Access is strictly enforced based on role and ownership: customers
   * may retrieve only their own order events, sellers only for their
   * fulfillments, admins for any history entry. Error responses are provided if
   * the ID does not exist or access is denied.
   *
   * @param connection
   * @param orderHistoryId Unique identifier for the target order history
   *   snapshot to retrieve.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Get(":orderHistoryId")
  public async at(
    @AdminAuth()
    admin: AdminPayload,
    @TypedParam("orderHistoryId")
    orderHistoryId: string & tags.Format<"uuid">,
  ): Promise<IShoppingMallOrderHistory> {
    try {
      return await getShoppingMallAdminOrderHistoriesOrderHistoryId({
        admin,
        orderHistoryId,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Update an order history record in shopping_mall_order_histories by
   * orderHistoryId (admin only).
   *
   * Update a specific order history record identified by orderHistoryId. The
   * operation enables admin users to correct or add additional information to
   * previously captured historical order snapshots. This API updates the
   * shopping_mall_order_histories table, which stores immutable snapshots of
   * order data. The update may include fields like snapshot_reason, order_total
   * adjustment, or corrections for compliance/audit purposes.
   *
   * Security considerations require exclusive admin access to this operation,
   * as these records are used for regulatory and audit reporting. An audit
   * trail is kept for every update, including the acting admin, changed fields,
   * and timestamp. Only fields that do not compromise the integrity of
   * immutable historical data may be updated. Attempts to update non-editable
   * fields or without sufficient permissions will result in an error response.
   *
   * Related APIs include endpoints for retrieving order histories, customer
   * service event logs, and escalations associated with orders. Error handling
   * includes conflict errors if another update has already occurred on the
   * snapshot, or if requested changes fail audit validation.
   *
   * @param connection
   * @param orderHistoryId The unique identifier of the order history record to
   *   update.
   * @param body Data to update for the specific order history record, using
   *   IShoppingMallOrderHistory.IUpdate structure.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Put(":orderHistoryId")
  public async update(
    @AdminAuth()
    admin: AdminPayload,
    @TypedParam("orderHistoryId")
    orderHistoryId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IShoppingMallOrderHistory.IUpdate,
  ): Promise<IShoppingMallOrderHistory> {
    try {
      return await putShoppingMallAdminOrderHistoriesOrderHistoryId({
        admin,
        orderHistoryId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
